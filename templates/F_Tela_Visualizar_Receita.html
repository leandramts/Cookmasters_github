{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="home-bg">

    <div class="container-auth" style="max-width: 700px; margin: 0 auto;">

        <h1>{{ nome }}</h1>

        {% if foto %}
            <img src="{{ foto }}" 
                 alt="Foto da receita"
                 style="width: 100%; border-radius: 12px; margin-bottom: 20px;">
        {% endif %}

        <hr style="margin: 20px 0;">

        <p>Chefe: 
            <a href="{% url 'visualizar_chefe' receita.autor.id %}">
                {{ receita.autor.usuario.nome }}
            </a>
        </p>
        <p><strong>Preço:</strong> R$ {{ preco }}</p>
        <p><strong>Descrição:</strong><br> {{ descricao }}</p>

        <hr style="margin: 20px 0;">

        {% if modo_liberado %}
            <p><strong>Modo de preparo:</strong><br> {{ modo_de_preparo }}</p>
        {% else %}
            <p><strong>Modo de preparo:</strong><br> 
                <span style="color: grey; font-style: italic;">
                    Compre a receita para visualizar o modo de preparo.
                </span>
            </p>

            <!-- ⭐ BOTÃO DE ADICIONAR AO CARRINHO ⭐ -->
            {% if user.is_authenticated and not modo_liberado %}
                <a href="{% url 'adicionar_ao_carrinho' receita.id %}"
                   class="botao-link" 
                   style="margin-top: 15px; display:block; text-align:center;">
                    Adicionar ao carrinho
                </a>
            {% endif %}

            <!-- ⭐ BOTÃO DE COMPRA DIRETA ⭐ -->
            <form method="POST" action="{% url 'selecionar_pagamento' receita_id %}">

                {% csrf_token %}
                <input type="hidden" name="compra_unica" value="{{ receita.id }}">
                <button class="botao-link" type="submit" style="margin-top: 15px;">
                    Comprar por R$ {{ preco }}
                </button>
            </form>
        {% endif %}

        <hr style="margin: 20px 0;">

        <p><strong>Tempo de preparo:</strong> {{ tempo_preparo }} min</p>
        <p><strong>Dificuldade:</strong> {{ dificuldade }}</p>
        <p><strong>Nota:</strong> {{ nota }}/5</p>

        <hr style="margin: 20px 0;">

        <h3 style="color:#088341; text-align:left;">Ingredientes</h3>
        <ul>
            {% for i in ingredientes %}
                <li>{{ i.nome }}</li>
            {% endfor %}
        </ul>

        <h3 style="color:#088341; text-align:left; margin-top:20px;">Tags</h3>
        {% if tags %}
            {% for tag in tags %}
                <span class="tag">{{ tag.nome }}</span>
            {% endfor %}
        {% else %}
            <p class="no-tag">Nenhuma tag informada</p>
        {% endif %}

        <br><br>

        <hr>
        <h3 style="color:#088341;">Avaliações</h3>
        {% for avaliacao in receita.e_avaliacoes_set.all %}
            <div style="margin-bottom: 10px; padding:10px; background:#f5fff5; border-radius:8px;">
                <strong>{{ avaliacao.consumidor.usuario.nome }}</strong> — Nota: {{ avaliacao.nota }}/5
                <p>{{ avaliacao.comentario }}</p>
            </div>
        {% empty %}
            <p>Nenhuma avaliação ainda.</p>
        {% endfor %}

        {% if modo_liberado and not avaliou %}
            <form method="GET" action="{% url 'avaliar_receita' receita.id %}">
                <button type="submit" class="botao-link" style="margin-top: 15px;">
                    Avaliar receita
                </button>
            </form>
        {% elif avaliou %}
            <p><strong>Você já avaliou esta receita.</strong></p>
        {% endif %}

        {% if user.is_authenticated and autor.usuario == user %}
    <div class="acoes-chefe">
        <a href="{% url 'editar_receita' receita.id %}" class="btn-editar">
            Editar Receita
        </a>
        
        <form method="POST" action="{% url 'excluir_receita' receita.id %}" onsubmit="return confirm('Tem certeza que deseja EXCLUIR permanentemente a receita {{ receita.nome }}?');" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-excluir">
                Excluir Receita
            </button>
        </form>
    </div>
{% endif %}

        <a href="{% url 'home' %}" class="botao-link" style="margin-top: 25px;">
            Voltar
        </a>

    </div>

</div>
{% endblock %}
